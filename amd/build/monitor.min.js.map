{"version":3,"file":"monitor.min.js","sources":["../src/monitor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Check student status for the quizaccess_announcements plugin.\n *\n * @module     quizaccess_announcements/monitor\n * @copyright  Jeffrey Black\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getstatus} from './repository';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Variables to hold the quizid, the time interval to check and the container element.\n * param {number} quizid id of the quiz.\n * param {number} studentinterval polling interval for students checking announcemnets.\n * param {number} delay polling interval for checking student status.\n * param {Element} hcont container for last announcement message.\n * param {Element} tcont table which contains student status.\n * param {number} ecnt count of number of failures.\n */\nvar quizid;\nvar studentinterval;\nvar delay;\nvar hcont;\nvar tcont;\nvar ecnt;\n\n\n/**\n * Clears classes to pretify rows.\n *\n * @param {Element} row row to remove classes for.\n */\nfunction clearclasses(row){\n    row.classList.remove('table-success');\n    row.classList.remove('table-warning');\n    row.classList.remove('table-danger');\n}\n\n/**\n * Updates the table of student data.\n *\n * @param {Element} ntbody new table body element to add row to.\n * @param {number|false} last timestamp of last time announcement was posted.\n */\nfunction updatestudentnow(ntbody, last) {\n    /**\n     * Updates the student data.\n     *\n     * @param {object} student objcet containing details of student.\n     */\n    return function updatestudent(student) {\n        let row = tcont.querySelector('tr.u_' + student.userid);\n        if(!row) {\n            window.console.log(\"Unable to find row for student \" + student.userid);\n            return;\n        }\n        try {\n            clearclasses(row);\n            row.querySelector('td.cell.time').innerHTML = student.str;\n            row.querySelector('td.cell.ago').innerHTML = student.ago;\n            if(student.ago > studentinterval*2) {\n                row.classList.add('table-danger');\n            } else if(student.ago > studentinterval) {\n                row.classList.add('table-warning');\n            } else if((last !== null) && (last > student.time)){\n                row.classList.add('table-warning');\n            } else {\n                row.classList.add('table-success');\n            }\n        } catch(e){\n            window.console.error(\"Error updating student status\", e);\n            ecnt = 10;\n        }\n        ntbody.appendChild(row);\n    };\n}\n\n/**\n * Makes request to get status.\n *\n */\nasync function fetchstatus(){\n    var getstatusp = getstatus(quizid)\n    .then((statret) => {\n        ecnt = 0;\n        hcont.innerHTML = statret.last.str;\n        var ntbody = document.createElement('tbody');\n        statret.status.forEach(updatestudentnow(ntbody, statret.last.time));\n        var row = tcont.rows[0];\n        while(row){\n            clearclasses(row);\n            ntbody.appendChild(row);\n            row = tcont.rows[0];\n        }\n        tcont.replaceWith(ntbody);\n        tcont = ntbody;\n        return statret;\n    }).catch((err) => {\n        window.console.error(\"Error in AJAX request\", err);\n        ecnt++;\n        return err;\n    });\n    await getstatusp;\n    if (ecnt < 5) {\n        window.setTimeout(fetchstatus, delay);\n    } else {\n        getString('monitor_ajax_error', 'quizaccess_announcements')\n        .then((str) => {\n            hcont.innerHTML = str;\n        }).catch((err) => {\n            window.console.error(\"Error getting string\", err);\n            hcont.innerHTML = 'Error fetching student status. Additionally, error fetching error string.';\n        });\n    }\n}\n\n/**\n * Sets up the page for monitoring student status.\n *\n * @param {number} qid id of the quiz.\n * @param {number} checkinterval how often students should fetch announcements.\n * @param {number} interval how often to update status.\n * @param {string} lastid id of the last post status element.\n * @param {string} contid id of the container element.\n */\nfunction init(qid, checkinterval, interval, lastid, contid){\n    quizid = qid;\n    studentinterval = parseInt(checkinterval);\n    delay = parseInt(interval)*1000;\n    hcont = document.getElementById(lastid);\n    tcont = document.getElementById(contid);\n    ecnt = 0;\n    if(!(tcont && (tcont = tcont.querySelector('tbody')))){\n        window.console.error(\"Unable to find table body to update.\", contid);\n        return;\n    }\n    window.setTimeout(fetchstatus, delay);\n}\n\nexport {init};\n"],"names":["quizid","studentinterval","delay","hcont","tcont","ecnt","clearclasses","row","classList","remove","updatestudentnow","ntbody","last","student","querySelector","userid","innerHTML","str","ago","add","time","e","window","console","error","appendChild","log","fetchstatus","getstatusp","then","statret","document","createElement","status","forEach","rows","replaceWith","catch","err","setTimeout","qid","checkinterval","interval","lastid","contid","parseInt","getElementById"],"mappings":"yqBAmCIA,OACAC,gBACAC,MACAC,MACAC,MACAC,cAQKC,aAAaC,KAClBA,IAAIC,UAAUC,OAAO,iBACrBF,IAAIC,UAAUC,OAAO,iBACrBF,IAAIC,UAAUC,OAAO,yBAShBC,iBAAiBC,OAAQC,aAMvB,SAAuBC,aACtBN,IAAMH,MAAMU,cAAc,QAAUD,QAAQE,WAC5CR,SAKAD,aAAaC,KACbA,IAAIO,cAAc,gBAAgBE,UAAYH,QAAQI,IACtDV,IAAIO,cAAc,eAAeE,UAAYH,QAAQK,IAClDL,QAAQK,IAAsB,EAAhBjB,gBACbM,IAAIC,UAAUW,IAAI,gBACZN,QAAQK,IAAMjB,iBAEJ,OAATW,MAAmBA,KAAOC,QAAQO,KADzCb,IAAIC,UAAUW,IAAI,iBAIlBZ,IAAIC,UAAUW,IAAI,iBAExB,MAAME,GACJC,OAAOC,QAAQC,MAAM,gCAAiCH,GACtDhB,KAAO,GAEXM,OAAOc,YAAYlB,UApBfe,OAAOC,QAAQG,IAAI,kCAAoCb,QAAQE,kBA4B5DY,+IAAf,8IACQC,YAAa,yBAAU5B,QAC1B6B,MAAK,SAACC,SACHzB,KAAO,EACPF,MAAMa,UAAYc,QAAQlB,KAAKK,QAC3BN,OAASoB,SAASC,cAAc,SACpCF,QAAQG,OAAOC,QAAQxB,iBAAiBC,OAAQmB,QAAQlB,KAAKQ,eACzDb,IAAMH,MAAM+B,KAAK,GACf5B,KACFD,aAAaC,KACbI,OAAOc,YAAYlB,KACnBA,IAAMH,MAAM+B,KAAK,UAErB/B,MAAMgC,YAAYzB,QAClBP,MAAQO,OACDmB,WACRO,OAAM,SAACC,YACNhB,OAAOC,QAAQC,MAAM,wBAAyBc,KAC9CjC,OACOiC,uBAELV,kBACFvB,KAAO,EACPiB,OAAOiB,WAAWZ,YAAazB,2BAErB,qBAAsB,4BAC/B2B,MAAK,SAACZ,KACHd,MAAMa,UAAYC,OACnBoB,OAAM,SAACC,KACNhB,OAAOC,QAAQC,MAAM,uBAAwBc,KAC7CnC,MAAMa,UAAY,6OAchBwB,IAAKC,cAAeC,SAAUC,OAAQC,WAChD5C,OAASwC,IACTvC,gBAAkB4C,SAASJ,eAC3BvC,MAA2B,IAAnB2C,SAASH,UACjBvC,MAAQ4B,SAASe,eAAeH,QAChCvC,MAAQ2B,SAASe,eAAeF,QAChCvC,KAAO,IACFD,QAAUA,MAAQA,MAAMU,cAAc,uBACvCQ,OAAOC,QAAQC,MAAM,uCAAwCoB,QAGjEtB,OAAOiB,WAAWZ,YAAazB"}